{% extends "layout.html" %}
{% block content %}
<h4>统计汇总</h4>
<form method="post" class="row g-2 mb-3">
  <div class="col-md-3">
    <label class="form-label">区间</label>
    <select class="form-select" name="range_type" id="range_type" onchange="toggleCustom(this.value)">
      <option value="this_month">本月</option>
      <option value="this_week">本周</option>
      <option value="custom">自定义</option>
    </select>
  </div>
  <div class="col-md-2" id="start_div" style="display:none;">
    <label class="form-label">开始</label><input class="form-control" type="date" name="start">
  </div>
  <div class="col-md-2" id="end_div" style="display:none;">
    <label class="form-label">结束</label><input class="form-control" type="date" name="end">
  </div>
  <div class="col-md-2 align-self-end">
    <button class="btn btn-primary">查询</button>
  </div>
</form>

<script>
function toggleCustom(v){
  document.getElementById('start_div').style.display = (v==='custom'?'':'none')
  document.getElementById('end_div').style.display = (v==='custom'?'':'none')
}
</script>

<div class="mb-3">
  <h5>区间：{{ summary.start_date }} 至 {{ summary.end_date }} （{{ summary.days_span }} 天）</h5>
  <table class="table table-bordered w-auto">
    <tr><th>总刷卡</th><td>${{ "%.2f"|format(summary.total_card) }}</td><th>总现金</th><td>${{ "%.2f"|format(summary.total_cash) }}</td></tr>
    <tr><th>总营业额</th><td>${{ "%.2f"|format(summary.total_amount) }}</td><th>总客人数</th><td>{{ summary.total_customers }}</td></tr>
    <tr><th>平均每日收入</th><td>${{ "%.2f"|format(summary.avg_daily_income) }}</td><th>平均每日客人数</th><td>{{ "%.2f"|format(summary.avg_daily_customers) }}</td></tr>
  </table>
</div>

<h5>图表</h5>
<div class="row">
  <div class="col-md-8"><canvas id="incomeChart"></canvas></div>
  <div class="col-md-4"><canvas id="serviceChart"></canvas></div>
</div>
<div class="row mt-3">
  <div class="col-md-6"><canvas id="therapistChart"></canvas></div>
</div>

<script>
function fetchChart(url, cb) {
  fetch(url).then(r=>r.json()).then(cb)
}
const start = "{{ summary.start_date }}";
const end = "{{ summary.end_date }}";
fetchChart("{{ url_for('main.chart_income') }}?start="+start+"&end="+end, function(d){
  const ctx = document.getElementById('incomeChart').getContext('2d');
  new Chart(ctx, {type:'line', data:{labels:d.labels, datasets:[{label:'每日收入', data:d.data, borderColor:'rgba(75, 192, 192, 1)', backgroundColor:'rgba(75,192,192,0.2)'}]}});
});
fetchChart("{{ url_for('main.chart_service') }}?start="+start+"&end="+end, function(d){
  const ctx = document.getElementById('serviceChart').getContext('2d');
  new Chart(ctx, {type:'bar', data:{labels:d.labels, datasets:[{label:'按服务收入', data:d.data, backgroundColor:'rgba(54,162,235,0.6)'}]}});
});
fetchChart("{{ url_for('main.chart_therapist') }}?start="+start+"&end="+end, function(d){
  const ctx = document.getElementById('therapistChart').getContext('2d');
  new Chart(ctx, {type:'bar', data:{labels:d.labels, datasets:[{label:'按技师收入', data:d.data, backgroundColor:'rgba(255,159,64,0.6)'}]}});  
});
</script>

<h5 class="mt-4">按技师汇总</h5>
<table class="table table-sm">
  <thead><tr><th>技师</th><th>单数</th><th>营业额</th><th>平均单价</th></tr></thead>
  <tbody>
    {% for name, s in therapist_summaries.items() %}
    <tr><td>{{ name }}</td><td>{{ s.count }}</td><td>${{ "%.2f"|format(s.revenue) }}</td><td>${{ "%.2f"|format((s.revenue / s.count) if s.count else 0) }}</td></tr>
    {% endfor %}
  </tbody>
</table>

<h5 class="mt-4">按服务汇总</h5>
<table class="table table-sm">
  <thead><tr><th>服务</th><th>单数</th><th>营业额</th></tr></thead>
  <tbody>
    {% for name, s in service_summary.items() %}
    <tr><td>{{ name }}</td><td>{{ s.count }}</td><td>${{ "%.2f"|format(s.revenue) }}</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
