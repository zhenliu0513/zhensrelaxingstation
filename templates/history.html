{% extends "layout.html" %}
{% block content %}
<h4>历史记录</h4>
<form class="row g-2 mb-3" method="get" action="{{ url_for('main.history') }}">
  <div class="col-md-2"><label class="form-label">开始</label><input type="date" name="start" class="form-control" value="{{ filters.start }}"></div>
  <div class="col-md-2"><label class="form-label">结束</label><input type="date" name="end" class="form-control" value="{{ filters.end }}"></div>
  <div class="col-md-2"><label class="form-label">服务</label>
    <select name="service" class="form-select">
      <option value="">全部</option>
      {% for s in service_types %}
      <option value="{{ s }}" {% if filters.service==s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2"><label class="form-label">技师</label>
    <select name="therapist" class="form-select">
      <option value="">全部</option>
      {% for t in therapists %}
      <option value="{{ t.name }}" {% if filters.therapist==t.name %}selected{% endif %}>{{ t.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2"><label class="form-label">排序</label>
    <select name="order" class="form-select">
      <option value="desc" {% if filters.order=='desc' %}selected{% endif %}>新到旧</option>
      <option value="asc" {% if filters.order=='asc' %}selected{% endif %}>旧到新</option>
    </select>
  </div>
  <div class="col-md-2 align-self-end">
    <button class="btn btn-primary">筛选</button>
    <a class="btn btn-secondary" href="{{ url_for('main.history') }}">重置</a>
    <a class="btn btn-success" href="{{ url_for('main.export_csv', start=filters.start, end=filters.end) }}">导出 CSV</a>
  </div>
</form>

<table class="table table-striped table-sm">
  <thead>
    <tr>
      <th>日期</th>
      <th>服务</th>
      <th>时长</th>
      <th>技师</th>
      <th>刷卡</th>
      <th>现金</th>
      <th>总额</th>
      <th>客数</th>
      <th>备注</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    {% for r in records %}
    <tr>
      <td>{{ r.date.isoformat() }}</td>
      <td>{{ r.service_type }}</td>
      <td>{{ r.duration }}</td>
      <td>{{ r.therapist.name if r.therapist else '' }}</td>
      <td>${{ "%.2f"|format(r.card_amount) }}</td>
      <td>${{ "%.2f"|format(r.cash_amount) }}</td>
      <td>${{ "%.2f"|format(r.total_amount) }}</td>
      <td>{{ r.customer_count }}</td>
      <td>{{ r.note }}</td>
      <td>
        <form method="post" action="{{ url_for('main.delete_record', rid=r.id) }}"
              style="display:inline;" onsubmit="return confirm('确认删除该记录吗？');">
          <button class="btn btn-danger btn-sm">删除</button>
        </form>
      </td>
    </tr>
    {% else %}
    <tr><td colspan="10" class="text-center">暂无记录</td></tr>
    {% endfor %}
  </tbody>
</table>

{% if pagination %}
<nav aria-label="Page navigation">
  <ul class="pagination">
    {% if pagination.has_prev %}
    <li class="page-item"><a class="page-link" href="{{ url_for('main.history', page=pagination.prev_num, **filters) }}">上一页</a></li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">上一页</span></li>
    {% endif %}
    <li class="page-item disabled"><span class="page-link">第 {{ pagination.page }} 页 / 共 {{ pagination.pages }} 页</span></li>
    {% if pagination.has_next %}
    <li class="page-item"><a class="page-link" href="{{ url_for('main.history', page=pagination.next_num, **filters) }}">下一页</a></li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">下一页</span></li>
    {% endif %}
  </ul>
</nav>
{% endif %}
{% endblock %}
